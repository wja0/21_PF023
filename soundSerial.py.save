import serial
import firebase_admin
import time

from firebase_admin import auth
from firebase_admin import credentials, db

from pyfcm import FCMNotification

APIKEY = "AAAAp7fGgNA:APA91bG3w58cfBLHhG4cRykjIS9O3rib5wIh-A67k8VeXWhVp_4vCWzNDnwtjot0vo18Zz2BcHk4vC9k8ArAqIEpWUg8v1j_PzsCKCT_PXHcV3biJqbDCbZx9piipb1uJc7D5w_gW2vt"
#자영
#TOKEN = "e2kvzJhvTl2fwt2znfYdb7:APA91bF_IuhorxGqmbaPJaa__lMovMF6zUyyBlAvcq6KsyWMLf0pSjVZ2clz2SdqZakQ1CL_-HXjuzH04lF-GgNepYiRLIsvJh3Q0TRkEySublKO6si_w3Er5WaetR-evdSXtG_ARjV9"
#수현
TOKEN = "ewf8khSsQR2lK9bw37ylJ_:APA91bF4npdqkLFVM3sqk85paNFINFPSTAz-RP2UZ2XbzrpvMU7Tl7uPev1q_HfkwNwPyDUZAewhi94Abquo10pwdAHfKL-uz7MtCeJmk2M_Q5Bx7Djmv3TsK0jhd6bSBGca9DKYtkeq"


push_service = FCMNotification(APIKEY)

def sendMessage(title, body):
    data_message = {
        "body" : body,
        "title": title
    }
    result = push_service.single_device_data_message(registration_id=TOKEN, data_message=data_message)
    print(result)

cred = credentials.Certificate("/home/pi/probono-da97e-firebase-adminsdk-23ap0-dce234980c.json")
firebase_admin.initialize_app(cred, {
                'databaseURL': 'https://probono-da97e-default-rtdb.firebaseio.com/' 
})

# bluetooth
#socket = BluetoothSocket(RFCOMM)
#socket.connect(("98:D3:71:FD:BF:91", 1))

ref = db.reference('alarm/alarm_03')


port = '/dev/ttyACM0'
brate = 9600 #boudrate
cmd = 'temp'

seri = serial.Serial(port, baudrate = brate, timeout = None)
print(seri.name)

seri.write(cmd.encode())

try :
    while True:
        if seri.in_waiting != 0 :
            content = seri.readline()
            print(content.decode(), end='') 
            if(float(content.decode()) == -1):
                ref.delete()
            else:
                now = time.localtime()
                ref.update({'title' : '울음 소리 감지'})
                ref.update({'comment': '아기가 울고 있어요!'})
                ref.update({'time'  :  "%04d/%02d/%02d %02d:%02d:%02d"%(now.tm_year, now.tm_mon, now.tm_mday, now.tm_hour,now.tm_min, now.tm_sec)})
                sendMessage("울음 소리 감지", "아기 상태를 확인해주세요!!")
                # Bluetooth
#               socket.send('3')

except KeyboardInterrupt:
    socket.close()
    print("강제종료")

